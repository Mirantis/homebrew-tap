name: Upload bottles

on:
  pull_request:
    types: [ labeled ]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  upload-bottle:
    if: ${{ github.event.label.name == 'bottle' }}
    strategy:
      max-parallel: 1
      matrix:
        os: [ ubuntu-22.04, macos-13, macos-14 ]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Load environment variables on Linux
        if: ${{ matrix.os == 'ubuntu-22.04' }}
        uses: c-py/action-dotenv-to-setenv@v4
        with:
          env-file: .github/development.env

      - name: Load environment variables on macOS
        if: ${{ matrix.os != 'ubuntu-22.04' }}
        run: |
          set -a
          source .github/development.env
          echo "KUBECTL_VER=${KUBECTL_VER}" >> "$GITHUB_ENV"
          set +a

      - name: Get Version Info
        run: |
          VERSION=$(grep 'VERSION = ' Formula/mkectl.rb | sed 's/VERSION = "\(.*\)".freeze/\1/' | sed 's/^[[:space:]]*//')
          echo "version=${VERSION}" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          brew install kubernetes-cli@${{ env.KUBECTL_VER }}  

      - name: Build the Homebrew bottle
        run: |
          rm -f mkectl--*.tar.gz

          brew install --build-bottle mkectl
          brew bottle mkectl

          bottle_file=$(ls -1 mkectl--*.tar.gz | head -n 1)
          corrected_bottle_file="${bottle_file/.bottle.[0-9]*.tar.gz/.bottle.tar.gz}"
          corrected_bottle_file=$(echo "$corrected_bottle_file" | sed 's/--/-/')

          mv "$bottle_file" "$corrected_bottle_file"
          echo "bottle_path=$(pwd)/$corrected_bottle_file" >> "$GITHUB_ENV"

          brew unlink mkectl || true
          
          brew install --build-bottle mkectl@${{ env.version }}
          brew bottle mkectl@${{ env.version }}
          
          versioned_bottle_file=$(ls -1 mkectl@${{ env.version }}*.tar.gz | head -n 1)
          cversioned_bottle_file=$(echo "$versioned_bottle_file" | sed 's/--/-/')
          
          mv "$versioned_bottle_file" "$cversioned_bottle_file"
          echo "versioned_bottle_path=$(pwd)/$cversioned_bottle_file" >> "$GITHUB_ENV"

      - name: Create a GitHub Release (if not existing)
        run: |
          TAG="mkectl-${{ env.version }}"
          RELEASE_EXISTS=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG} | jq -r '.id')

          if [ "$RELEASE_EXISTS" == "null" ]; then
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"tag_name\":\"${TAG}\", \"name\":\"${TAG}\"}" \
              https://api.github.com/repos/${{ github.repository }}/releases
          fi

          sleep 10
          
          echo "Waiting for the release to become available..."
          until [ "$(curl -H 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG} | jq -r '.id')" != "null" ]; do
            echo "Release not available yet. Retrying in 10 seconds..."
            sleep 10
          done
      
          echo "Release ${TAG} is now available."

      - name: Upload the Bottles to GitHub Release
        run: |
          TAG="mkectl-${{ env.version }}"

          # Get the release ID with retry logic
          get_release_id() {
            local retries=5
            local count=0
            local delay=5

            while [ $count -lt $retries ]; do
              RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG} | jq -r '.id')

              if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
                echo "$RELEASE_ID"
                return 0
              fi

              echo "Release ID not found. Retrying in $delay seconds..."
              sleep $delay
              count=$((count + 1))
              delay=$((delay * 2))  # Exponential backoff
            done

            echo "Failed to fetch release ID after $retries attempts."
            return 1
          }

          RELEASE_ID=$(get_release_id) || exit 1

          upload_bottle() {
            local provided_bottle_path="$1"
            local retries=5
            local count=0
            local delay=5

            while [ $count -lt $retries ]; do
              response=$(curl -s -w "%{http_code}" -o response.json -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -F "file=@${provided_bottle_path}" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/${RELEASE_ID}/assets?name=$(basename "${provided_bottle_path}")")

              if [ "$response" -eq 201 ]; then
                echo "Bottle uploaded successfully."
                return 0
              else
                message=$(jq -r '.message' response.json)
                if [ "$message" == "Not Found" ]; then
                  echo "Upload failed with 'Not Found'. Retrying in $delay seconds..."
                else
                  echo "Upload failed with response: $message"
                  return 1
                fi
              fi

              sleep $delay
              count=$((count + 1))
              delay=$((delay * 2))  # Exponential backoff
            done

            echo "Failed to upload bottle after $retries attempts."
            return 1
          }

          echo "Uploading bottle: ${{ env.bottle_path }}"
          upload_bottle "${{ env.bottle_path }}"
          echo "Uploading bottle: ${{ env.versioned_bottle_path }}"
          upload_bottle "${{ env.versioned_bottle_path }}"

      - name: Update Homebrew Formula
        run: |
          ## TODO: DRY this out
          
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git config pull.ff only
          git checkout update-mkectl-${{ env.version }}
          git pull

          FORMULA_PATH="Formula/mkectl.rb"
          VERSIONED_FORMULA_PATH="Formula/mkectl@${{ env.version }}.rb"
          
          if command -v sha256sum > /dev/null; then
            checksum=$(sha256sum "${{ env.bottle_path }}" | awk '{print $1}')
            versioned_checksum=$(sha256sum "${{ env.versioned_bottle_path }}" | awk '{print $1}')
          else
            checksum=$(shasum -a 256 "${{ env.bottle_path }}" | awk '{print $1}')
            versioned_checksum=$(shasum -a 256 "${{ env.versioned_bottle_path }}" | awk '{print $1}')
          fi

          echo "checksum is $checksum"
          echo "versioned checksum is $versioned_checksum"
          
          awk -v matrixos="${{ matrix.os }}" -v checksum="$checksum" '
              /bottle do/ {
                in_bottle_block = 1
                print
                next
              }

              in_bottle_block && /sha256/ {
                  if ($0 ~ /ventura/ && matrixos == "macos-13") {
                    $0 = "    sha256 cellar: :any_skip_relocation, ventura: \"" checksum "\""
                  } else if ($0 ~ /arm64_sonoma/ && matrixos == "macos-14") {
                    $0 = "    sha256 cellar: :any_skip_relocation, arm64_sonoma: \"" checksum "\""
                  } else if ($0 ~ /x86_64_linux/ && matrixos == "ubuntu-22.04") {
                    $0 = "    sha256 cellar: :any_skip_relocation, x86_64_linux: \"" checksum "\""
                  }
              }

              { print }
          ' "$FORMULA_PATH" > tmp && mv tmp "$FORMULA_PATH"

          cat $FORMULA_PATH
          
          cp $FORMULA_PATH Formula/mkectl@${{ env.version }}.rb
          stripped_version=$(echo "${{ env.version }}" | tr -d '.')
          if [ "${{ matrix.os }}" == "ubuntu-22.04" ]; then
            sed -i "s/class Mkectl/class MkectlAT${stripped_version}/g" $VERSIONED_FORMULA_PATH
          else
            sed -i '' "s/class Mkectl/class MkectlAT${stripped_version}/g" $VERSIONED_FORMULA_PATH
          fi
          
          awk -v matrixos="${{ matrix.os }}" -v checksum="$versioned_checksum" '
              /bottle do/ {
                in_bottle_block = 1
                print
                next
              }

              in_bottle_block && /sha256/ {
                  if ($0 ~ /ventura/ && matrixos == "macos-13") {
                    $0 = "    sha256 cellar: :any_skip_relocation, ventura: \"" checksum "\""
                  } else if ($0 ~ /arm64_sonoma/ && matrixos == "macos-14") {
                    $0 = "    sha256 cellar: :any_skip_relocation, arm64_sonoma: \"" checksum "\""
                  } else if ($0 ~ /x86_64_linux/ && matrixos == "ubuntu-22.04") {
                    $0 = "    sha256 cellar: :any_skip_relocation, x86_64_linux: \"" checksum "\""
                  }
              }

              { print }
          ' "$VERSIONED_FORMULA_PATH" > tmp && mv tmp "$VERSIONED_FORMULA_PATH"

          rm -f ${{ env.bottle_path }}
          rm -f ${{ env.versioned_bottle_path }}
          
          git add $FORMULA_PATH
          git add $VERSIONED_FORMULA_PATH
          git commit -m "Update bottle for ${{ matrix.os }} to ${{ env.version }}"
          git push origin update-mkectl-${{ env.version }}

  trigger-tests-dispatch:
    needs: upload-bottle
    runs-on: ubuntu-22.04
    steps:
      - name: Trigger tests dispatch
        run: |
          curl --request POST \
            --url https://api.github.com/repos/${{ github.repository }}/actions/workflows/tests.yml/dispatches \
            --header "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            --header "Content-Type: application/json" \
            --data '{"ref": "${{ github.event.pull_request.head.ref }}", "inputs": {"checkout_ref": "${{ github.sha }}"}}'
